<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Player</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
  body,html{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;font-family:sans-serif;}
  .swiper{width:100%;height:100%;max-width:480px;margin:0 auto;background:#000;position:relative;}
  .swiper-slide{display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;position:relative;background:#000;}
  iframe{width:100%;height:100%;border:0;pointer-events:auto;}
  .smart-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;background:transparent;cursor:pointer;
    clip-path: polygon(0% 0%, 100% 0%, 100% 80%, 65% 80%, 65% 100%, 0% 100%);}
  .play-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70px;height:70px;z-index:55;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:opacity 0.2s;}
  .play-btn::after{content:'';width:0;height:0;border-left:25px solid #fff;border-top:15px solid transparent;border-bottom:15px solid transparent;margin-left:5px;}
  .play-btn.hide{opacity:0;pointer-events:none;}
  .sub-box{position:absolute;left:50%;transform:translateX(-50%);bottom:10%;width:auto;max-width:90%;text-align:center;color:#fff;z-index:60;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.8);background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:8px;font-weight:600;line-height:1.4;opacity:0;transition:all 0.1s;}
  .sub-box.show{opacity:1;}
  /* 썸네일 스타일 */
  .thumb{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:1;transition:opacity 0.3s;}
  .thumb.hide{opacity:0;pointer-events:none;}
  .player-wrap{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;}
  .full .player-wrap{position:absolute;top:0;left:50%;width:177.78vh;height:100%;transform:translateX(-50%);object-fit:cover;}
  @media(max-aspect-ratio:9/16){.full .player-wrap{width:320%;height:100%;left:-110%;transform:none;}}
  .fit{display:flex;flex-direction:column;}
  .fit .top{width:100%;padding:15px;color:#fff;text-align:center;z-index:10;font-weight:bold;min-height:50px;}
  .fit .vid-wrap{position:relative;width:100%;flex:1;display:flex;align-items:center;justify-content:center;background:#000;}
  .fit .thumb{position:absolute;top:0;left:0;width:100%;height:100%;}
  .fit .player-wrap{position:absolute;top:0;left:0;width:100%;height:100%;}
  .badge{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:5px 15px;border-radius:15px;font-size:14px;z-index:20;pointer-events:none;}
</style>
</head>
<body>
<div class="swiper"><div class="swiper-wrapper" id="wrap"></div></div>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
const list=[{"id":"BTn8QLqevj0","title":"","mode":"full","start":200,"end":210,"top":"","sub":""}];
let swiper, players={}, subs={}, timer=null, playersReady=0;
let userInteracted = false;
let isTransitioning = false;

function getThumbUrl(videoId){
  // 고화질 썸네일 (maxresdefault가 없으면 hqdefault 사용)
  return 'https://img.youtube.com/vi/'+videoId+'/hqdefault.jpg';
}

function init(){
  const w=document.getElementById('wrap');
  list.forEach((v,i)=>{
    const d=document.createElement('div'); 
    d.className='swiper-slide '+(v.mode==='fit'?'fit':'full');
    subs[i]=parseSrt(v.sub);
    
    const thumb=`<div class="thumb" id="thumb-${i}" style="background-image:url('${getThumbUrl(v.id)}')"></div>`;
    const L=`<div class="smart-layer" onclick="handleLayerClick(${i})"></div>`;
    const B=`<div class="play-btn" id="btn-${i}" onclick="handlePlayClick(${i})"></div>`;
    const S=`<div class="sub-box" id="sub-${i}"></div>`;
    const player=`<div class="player-wrap"><div id="p-${i}"></div></div>`;
    
    if(v.mode==='fit') {
      d.innerHTML=`${v.top?`<div class="top">${v.top}</div>`:''}<div class="vid-wrap">${thumb}${player}${L}${B}${S}</div>`;
    } else {
      d.innerHTML=`${thumb}${player}${L}${B}${S}<div class="badge">${v.title}</div>`;
    }
    w.appendChild(d);
  });
  
  swiper=new Swiper('.swiper',{
    direction:'vertical',
    effect:'slide',
    speed:400,
    loop: false,
    on:{ 
      slideChange:()=>{ 
        if(!isTransitioning) {
          handleSlideChange();
        }
      } 
    }
  });
  
  window.addEventListener('resize',()=>{
    document.querySelectorAll('.sub-box.show').forEach(el=>font(el,el.innerText.length));
  });
}

function handleSlideChange(){
  stopAll();
  const idx = swiper.activeIndex;
  if(userInteracted){
    setTimeout(()=>play(idx), 300);
  }
}

function handlePlayClick(i){
  userInteracted = true;
  play(i);
}

function handleLayerClick(i){
  if(!userInteracted){
    userInteracted = true;
    play(i);
    return;
  }
  toggle(i);
}

function onYouTubeIframeAPIReady(){
  list.forEach((v,i)=>{
    players[i]=new YT.Player('p-'+i,{
      videoId:v.id, 
      host:'https://www.youtube.com',
      playerVars:{
        'autoplay':0,
        'controls':0,
        'rel':0,
        'showinfo':0,
        'modestbranding':1,
        'playsinline':1,
        'fs':0,
        'iv_load_policy':3,
        'start':v.start,
        'enablejsapi':1,
        'origin':window.location.origin
      },
      events:{
        'onReady':(e)=>onPlayerReady(e,i),
        'onStateChange':(e)=>state(e,i),
        'onError':(e)=>onPlayerError(e,i)
      }
    });
  });
}

function onPlayerReady(e,i){
  playersReady++;
  if(playersReady === list.length){
    console.log('All players ready');
  }
}

function onPlayerError(e, i) {
  console.error('Player ' + i + ' error:', e.data);
  if(userInteracted){
    setTimeout(()=>next(), 1000);
  }
}

function hideThumb(i){
  const thumb = document.getElementById('thumb-'+i);
  if(thumb) thumb.classList.add('hide');
}

function showThumb(i){
  const thumb = document.getElementById('thumb-'+i);
  if(thumb) thumb.classList.remove('hide');
}

function state(e,i){
  const btn=document.getElementById('btn-'+i);
  const currentIdx = swiper ? swiper.activeIndex : 0;
  
  if(i !== currentIdx) return;
  
  if(e.data===YT.PlayerState.PLAYING){
    if(btn) btn.classList.add('hide');
    hideThumb(i);
    startMon(i); 
  } else if(e.data===YT.PlayerState.PAUSED){
    if(btn) btn.classList.remove('hide');
  } else if(e.data===YT.PlayerState.ENDED){
    if(btn) btn.classList.remove('hide');
    clearInterval(timer);
    timer = null;
    if(userInteracted){
      setTimeout(()=>next(), 300);
    }
  }
}

function toggle(i){
  const p=players[i];
  if(p && p.getPlayerState){ 
    const state = p.getPlayerState();
    if(state===YT.PlayerState.PLAYING){
      p.pauseVideo();
    } else {
      p.playVideo();
    }
  }
}

function play(i){
  const p=players[i];
  if(!p) return;
  
  if(!p.playVideo || !p.seekTo) {
    setTimeout(()=>play(i), 300);
    return;
  }
  
  const startTime = list[i].start || 0;
  try {
    p.seekTo(startTime, true);
    setTimeout(()=>{
      try {
        p.playVideo();
      } catch(e) {
        console.log('playVideo error:', e);
      }
    }, 150);
  } catch(e) {
    console.log('Play error:', e);
  }
}

function stopAll(){
  if(timer) {
    clearInterval(timer);
    timer = null;
  }
  document.querySelectorAll('.sub-box').forEach(el=>{
    el.classList.remove('show');
    el.innerHTML='';
  });
  
  Object.keys(players).forEach(idx=>{ 
    const p = players[idx];
    if(p && p.pauseVideo) {
      try {
        p.pauseVideo();
      } catch(e) {}
    }
    showThumb(parseInt(idx));
  });
}

function next(){
  if(isTransitioning) return;
  isTransitioning = true;
  
  const idx=swiper.activeIndex;
  
  if(idx < list.length - 1){
    swiper.slideNext();
    setTimeout(()=>{ isTransitioning = false; }, 500);
  } else {
    stopAll();
    swiper.slideTo(0, 400);
    setTimeout(()=>{
      isTransitioning = false;
      if(userInteracted){
        play(0);
      }
    }, 500);
  }
}

function startMon(i){
  if(timer) clearInterval(timer);
  
  const p=players[i];
  const end=list[i].end;
  const start=list[i].start || 0;
  const el=document.getElementById('sub-'+i);
  const sDat=subs[i];
  
  timer=setInterval(()=>{
    if(!p || !p.getCurrentTime) return;
    
    let t;
    try {
      t = p.getCurrentTime();
    } catch(e) {
      return;
    }
    
    if(end > start && t >= (end - 0.3)){
      clearInterval(timer);
      timer = null;
      try {
        p.pauseVideo();
      } catch(e) {}
      setTimeout(()=>next(), 200);
      return;
    }
    
    if(sDat && sDat.length && el){
      const row=sDat.find(x=>t>=x.s && t<=x.e);
      if(row){
        const txt=row.t.replace(/\n/g,'<br>');
        if(el.innerHTML!==txt){ 
          el.innerHTML=txt; 
          el.classList.add('show'); 
          font(el,row.t.length); 
        }
      } else { 
        el.classList.remove('show'); 
        el.innerHTML=''; 
      }
    }
  }, 100);
}

function font(el,len){
  const w=document.querySelector('.swiper')?.clientWidth||window.innerWidth;
  let r=0.045; 
  if(len<=5) r=0.08; 
  else if(len<=15) r=0.06; 
  else if(len<=30) r=0.05; 
  else r=0.04;
  el.style.fontSize=(w*r)+'px';
}

function parseSrt(t){
  if(!t || !t.includes('-->')) return t?[{s:0,e:9999,t:t}]:[];
  const r=[];
  let m;
  const p=/(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\n|\n$|$)/g;
  while((m=p.exec(t+'\n\n'))!==null){
    r.push({s:h2s(m[2]),e:h2s(m[3]),t:m[4].trim()});
  }
  return r;
}

function h2s(s){ 
  const p=s.split(':');
  const c=p[2].split(','); 
  return parseInt(p[0])*3600+parseInt(p[1])*60+parseInt(c[0])+parseInt(c[1])/1000;
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',init);
} else {
  init();
}
</script>
</body>
</html>