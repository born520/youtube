<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>유튜브 플레이어</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  
  <style>
    body, html { margin: 0; padding: 0; width: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
    body, html, .swiper, .swiper-slide { 
      height: 100vh; 
      height: 100dvh; 
    }

    .swiper { width: 100%; max-width: 480px; margin: 0 auto; background: #000; position: relative; }
    .swiper-slide { background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; position: relative; }

    .video-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1;
    }
    iframe { width: 100%; height: 100%; border: 0; pointer-events: none; }

    .interaction-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 50; cursor: pointer;
      background: rgba(0,0,0,0);
    }

    .slide-full .video-container iframe {
      position: absolute; top: 0; left: 50%;
      width: 177.78vh; height: 100dvh;
      transform: translateX(-50%); object-fit: cover;
    }
    @media (max-aspect-ratio: 9/16) {
      .slide-full .video-container iframe { width: 320%; height: 100%; left: -110%; transform: none; }
    }

    /* [MODE: FIT] 레이아웃 */
    .slide-fit {
      display: flex; flex-direction: column; justify-content: space-between; background: #000;
    }
    
    .slide-fit .top-msg, .slide-fit .bottom-msg {
      width: 100%; 
      padding: 10px 10px; /* 좌우 여백 최소화 */
      box-sizing: border-box;
      color: #fff; text-align: center; z-index: 10;
      font-weight: 800; 
      flex-shrink: 0; 
      background: #000;
      
      display: flex; align-items: center; justify-content: center;
      white-space: pre-wrap;
      word-break: keep-all; 
      line-height: 1.1; /* 줄간격 타이트하게 */
    }

    .slide-fit .top-msg { 
      min-height: 60px;
      font-size: 20px; 
    }
    
    /* [하단 자막: 가로폭 꽉 채우기 위한 설정] */
    .slide-fit .bottom-msg { 
      min-height: 100px;
      /* 자막 영역을 더 넓게 잡음 */
      padding-bottom: 30px; 
      color: #FFEB3B; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      transition: font-size 0.1s;
    }

    .slide-fit .video-wrapper {
      position: relative; width: 100%; flex: 1; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; background: #000;
    }
    .slide-fit .video-wrapper iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; 
    }

    .title-badge {
      position: absolute; top: 20px;
      left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px;
      border-radius: 15px; font-size: 14px; z-index: 20;
      opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    .swiper-slide-active .title-badge { opacity: 1; }
  </style>
</head>
<body>

<div class="swiper">
  <div class="swiper-wrapper" id="slide-wrapper"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const videoList = [{"videoId":"rvPVVyl7l98","title":"","viewMode":"fit","start":14.5,"end":30,"topText":"테스트 페이지","bottomText":"반갑습니다."}];
  let swiper;
  let players = {};
  
  let savedSoundState = localStorage.getItem('isSoundOn');
  let isGlobalSoundOn = (savedSoundState === 'true');

  function initApp() {
    const wrapper = document.getElementById('slide-wrapper');
    
    videoList.forEach((v, idx) => {
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      const interactionLayer = `<div class="interaction-layer" onclick="activateSound(${idx})"></div>`;

      let html = '';
      if (v.viewMode === 'fit') {
        slide.classList.add('slide-fit');
        // 실제 텍스트 길이와 내용을 데이터 속성으로 저장
        const textLen = v.bottomText ? v.bottomText.replace(/s/g, '').length : 0; 
        
        html = `
          <div class="top-msg">${v.topText}</div>
          <div class="video-wrapper">
            <div id="player-${idx}"></div>
            ${interactionLayer}
          </div>
          <div class="bottom-msg" id="bottom-msg-${idx}" data-text="${v.bottomText}" data-len="${textLen}">${v.bottomText}</div>`;
      } else {
        slide.classList.add('slide-full');
        html = `
          <div class="video-container">
            <div id="player-${idx}"></div>
            ${interactionLayer}
          </div>
          <div class="title-badge">${v.title}</div>`;
      }
      slide.innerHTML = html;
      wrapper.appendChild(slide);
    });

    swiper = new Swiper('.swiper', {
      direction: 'vertical',
      effect: 'slide',
      speed: 400,
      loop: false, 
      on: {
        slideChange: function () {
          const idx = this.activeIndex;
          playVideo(idx);
          pauseVideo(this.previousIndex);
        }
      }
    });

    adjustSubtitleSizes();
    window.addEventListener('resize', adjustSubtitleSizes);

    loadYoutubeApi();
  }

  // [핵심] 자막 크기 자동 최적화 함수 (가로폭 꽉 채우기)
  function adjustSubtitleSizes() {
    document.querySelectorAll('.bottom-msg').forEach(el => {
      const text = el.getAttribute('data-text');
      if (!text) return;
      const len = text.length;
      
      // 글자 수에 따라 화면 너비(vw)를 꽉 채울 수 있는 폰트 크기 계산
      // 5글자 이하면 15vw (초대형)
      // 20글자면 줄바꿈 고려해서 적절히 조절
      let sizeVw = 6.0;

      if (len <= 5) {
        sizeVw = 16.0; // 5글자 이하: 화면 터질듯한 크기
      } else if (len <= 10) {
        sizeVw = 11.0; // 10글자 이하: 매우 큼
      } else if (len <= 20) {
        sizeVw = 8.5;  // 20글자 이하: 큼
      } else if (len <= 40) {
        sizeVw = 6.5;  // 두 줄 정도 예상
      } else {
        sizeVw = 5.0;  // 긴 문장
      }

      el.style.fontSize = sizeVw + 'vw';
    });
  }

  function loadYoutubeApi() {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  }

  window.onYouTubeIframeAPIReady = function() {
    videoList.forEach((v, idx) => {
      players[idx] = new YT.Player('player-' + idx, {
        videoId: v.videoId,
        host: 'https://www.youtube.com',
        playerVars: {
          'autoplay': 1, 'mute': 1, 'controls': 0, 'rel': 0, 
          'showinfo': 0, 'modestbranding': 1, 'playsinline': 1, 
          'fs': 0, 'disablekb': 1, 'iv_load_policy': 3,
          'cc_load_policy': 0, // [중요] 유튜브 자체 자막 끄기 (시트 자막 사용)
          'start': v.start, 'end': v.end > 0 ? v.end : undefined,
          'origin': window.location.origin
        },
        events: {
          'onReady': (event) => {
            if (idx === 0) {
              if (isGlobalSoundOn) {
                 event.target.unMute();
              } else {
                 event.target.mute(); 
              }
              event.target.playVideo();
              setTimeout(() => {
                const state = event.target.getPlayerState();
                if (state !== YT.PlayerState.PLAYING && state !== YT.PlayerState.BUFFERING) {
                   event.target.playVideo();
                }
              }, 500);
            }
          },
          'onStateChange': (event) => onPlayerStateChange(event, idx)
        }
      });
    });
  };

  function onPlayerStateChange(event, idx) {
    if (event.data === YT.PlayerState.ENDED) {
      if(idx < videoList.length - 1) {
        swiper.slideNext();
      } else {
        swiper.slideTo(0);
        setTimeout(() => playVideo(0), 300);
      }
    }
  }

  function activateSound(idx) {
    isGlobalSoundOn = true;
    localStorage.setItem('isSoundOn', 'true'); 

    if (players[idx]) {
      players[idx].unMute();
      if (players[idx].getPlayerState() !== YT.PlayerState.PLAYING) {
        players[idx].playVideo();
      }
    }
  }

  function playVideo(idx) {
    if (players[idx] && typeof players[idx].playVideo === 'function') {
      const v = videoList[idx];
      if (isGlobalSoundOn) {
        players[idx].unMute();
      } else {
        players[idx].mute();
      }
      players[idx].seekTo(v.start || 0);
      players[idx].playVideo();
    }
  }

  function pauseVideo(idx) {
    if (players[idx] && typeof players[idx].pauseVideo === 'function') {
      players[idx].pauseVideo();
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
</script>
</body>
</html>