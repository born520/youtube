<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>플레이어</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
    
    .swiper { width: 100%; max-width: 480px; height: 100vh; margin: 0 auto; background: #000; position: relative; }
    .swiper-slide { width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; position: relative; }

    .video-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    iframe { width: 100%; height: 100%; border: 0; }

    /* [MODE: FULL] 쇼츠 스타일 */
    .slide-full .video-container iframe {
      position: absolute;
      top: 0; left: 50%;
      width: 177.78vh; 
      height: 100vh;
      transform: translateX(-50%);
      object-fit: cover;
      pointer-events: none; /* UI 조작 방지 */
    }
    @media (max-aspect-ratio: 9/16) {
      .slide-full .video-container iframe {
         width: 320%; height: 100%; left: -110%; transform: none; 
      }
    }

    /* [MODE: FIT] 가로 영상 중앙 배치 + 상하 텍스트 */
    .slide-fit {
      display: flex; flex-direction: column; justify-content: space-between; background: #000;
    }
    .slide-fit .top-msg, .slide-fit .bottom-msg {
      width: 100%; padding: 20px; box-sizing: border-box;
      color: #fff; text-align: center; z-index: 10;
      font-size: 18px; font-weight: bold; line-height: 1.5;
      min-height: 15%; display: flex; align-items: center; justify-content: center;
      background: #000;
    }
    .slide-fit .video-wrapper {
      position: relative; 
      width: 100%; 
      padding-bottom: 56.25%; /* 16:9 비율 공간 확보 */
      background: #000; 
      flex-grow: 1; 
      display: flex; 
      align-items: center;
      overflow: hidden; /* 중요: 확대된 영상의 넘치는 부분 자르기 */
    }
    .slide-fit .video-wrapper iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      /* 1.35배 확대하여 유튜브 상단 타이틀바와 하단 컨트롤바를 화면 밖으로 밀어냄 
         pointer-events: none으로 클릭 방지 (불필요한 UI 노출 방지)
      */
      transform: scale(1.35); 
      transform-origin: center center;
      pointer-events: none; 
    }

    /* 타이틀 배지 (Full 모드용) */
    .title-badge {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px;
      border-radius: 15px; font-size: 14px; z-index: 20;
      opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    .swiper-slide-active .title-badge { opacity: 1; }

  </style>
</head>
<body>

<div class="swiper">
  <div class="swiper-wrapper" id="slide-wrapper"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const videoList = [{"videoId":"jN_tDQOP0BQ","title":"시동위키","viewMode":"fit","start":3,"end":10,"topText":"테스트 페이지","bottomText":"반갑습니다."}];
  
  let swiper;
  let players = {};
  
  // 브라우저 정책 대응: 일단 음소거로 시작 후 소리 켜기 시도
  let isGlobalMuted = true; 

  function initApp() {
    const wrapper = document.getElementById('slide-wrapper');
    
    videoList.forEach((v, idx) => {
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      
      if (v.viewMode === 'fit') {
        slide.classList.add('slide-fit');
        slide.innerHTML = `
          <div class="top-msg">${v.topText}</div>
          <div class="video-wrapper">
            <div id="player-${idx}"></div>
          </div>
          <div class="bottom-msg">${v.bottomText}</div>
        `;
      } else {
        slide.classList.add('slide-full');
        slide.innerHTML = `
          <div class="video-container">
            <div id="player-${idx}"></div>
          </div>
          <div class="title-badge">${v.title}</div>
        `;
      }
      wrapper.appendChild(slide);
    });

    swiper = new Swiper('.swiper', {
      direction: 'vertical',
      effect: 'slide',
      speed: 400,
      initialSlide: 0, // 항상 처음부터 시작
      on: {
        init: function() {
           // 초기화 시 0번으로 확실히 이동
           this.slideTo(0, 0);
        },
        slideChange: function () {
          const idx = this.activeIndex;
          playVideo(idx);
          pauseVideo(this.previousIndex);
        }
      }
    });
  }

  function onYouTubeIframeAPIReady() {
    videoList.forEach((v, idx) => {
      players[idx] = new YT.Player('player-' + idx, {
        videoId: v.videoId,
        playerVars: {
          'autoplay': 0, 
          'controls': 0, // 컨트롤바 숨김
          'rel': 0,      // 관련 영상 최소화
          'showinfo': 0, 
          'modestbranding': 1,
          'playsinline': 1, 
          'fs': 0, 
          'disablekb': 1,
          'iv_load_policy': 3, // 주석 숨김
          'start': v.start, 
          'end': v.end > 0 ? v.end : undefined
        },
        events: {
          'onReady': (event) => {
            // 첫 번째 영상 준비되면 즉시 재생
            if (idx === 0) {
              event.target.mute(); // 일단 음소거로 재생 (브라우저 차단 방지)
              event.target.playVideo();
            }
          },
          'onStateChange': (event) => onPlayerStateChange(event, idx)
        }
      });
    });
  }

  function onPlayerStateChange(event, idx) {
    // 재생 시작 시(PLAYING) 소리 켜기 시도
    if (event.data === YT.PlayerState.PLAYING) {
       // 만약 음소거 상태라면 소리 켜기 시도
       if (players[idx].isMuted()) {
         players[idx].unMute(); 
         // 주의: 사용자 인터랙션(터치) 없으면 브라우저가 다시 Mute 시킬 수 있음
       }
    }

    // 영상 끝나면(ENDED) -> 바로 다음 슬라이드 (추천화면 볼 틈 없이)
    if (event.data === YT.PlayerState.ENDED) {
      if(idx < videoList.length - 1) {
        swiper.slideNext();
      } else {
        swiper.slideTo(0); // 마지막이면 처음으로
      }
    }
  }

  function playVideo(idx) {
    if (players[idx] && typeof players[idx].playVideo === 'function') {
      const v = videoList[idx];
      players[idx].seekTo(v.start || 0);
      players[idx].playVideo();
    }
  }

  function pauseVideo(idx) {
    if (players[idx] && typeof players[idx].pauseVideo === 'function') {
      players[idx].pauseVideo();
    }
  }

  initApp();
</script>
</body>
</html>