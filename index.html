<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Player</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
  body,html{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;font-family:sans-serif;}
  .swiper{width:100%;height:100%;max-width:480px;margin:0 auto;background:#000;position:relative;}
  .swiper-slide{display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;position:relative;background:#000;}
  iframe{width:100%;height:100%;border:0;pointer-events:auto;}
  .smart-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;background:transparent;cursor:pointer;
    clip-path: polygon(0% 0%, 100% 0%, 100% 80%, 65% 80%, 65% 100%, 0% 100%);}
  .play-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70px;height:70px;z-index:55;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:opacity 0.2s;}
  .play-btn::after{content:'';width:0;height:0;border-left:25px solid #fff;border-top:15px solid transparent;border-bottom:15px solid transparent;margin-left:5px;}
  .play-btn.hide{opacity:0;pointer-events:none;}
  .sub-box{position:absolute;left:50%;transform:translateX(-50%);bottom:10%;width:auto;max-width:90%;text-align:center;color:#fff;z-index:60;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.8);background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:8px;font-weight:600;line-height:1.4;opacity:0;transition:all 0.1s;}
  .sub-box.show{opacity:1;}
  .thumb{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:1;transition:opacity 0.3s;}
  .thumb.hide{opacity:0;pointer-events:none;}
  .player-wrap{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;}
  .full .player-wrap{position:absolute;top:0;left:50%;width:177.78vh;height:100%;transform:translateX(-50%);object-fit:cover;}
  @media(max-aspect-ratio:9/16){.full .player-wrap{width:320%;height:100%;left:-110%;transform:none;}}
  .fit{display:flex;flex-direction:column;}
  .fit .top{width:100%;padding:15px;color:#fff;text-align:center;z-index:10;font-weight:bold;min-height:50px;}
  .fit .vid-wrap{position:relative;width:100%;flex:1;display:flex;align-items:center;justify-content:center;background:#000;}
  .fit .thumb{position:absolute;top:0;left:0;width:100%;height:100%;}
  .fit .player-wrap{position:absolute;top:0;left:0;width:100%;height:100%;}
  .badge{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:5px 15px;border-radius:15px;font-size:14px;z-index:20;pointer-events:none;}
  .loading{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.9);color:#333;padding:8px 16px;border-radius:20px;font-size:12px;z-index:999;display:none;}
  .loading.show{display:block;}
</style>
</head>
<body>
<div class="loading" id="loading">로딩 중...</div>
<div class="swiper"><div class="swiper-wrapper" id="wrap"></div></div>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
const list=[{"id":"sI8d4Q0zNgo","title":"","mode":"full","start":200,"end":210,"top":"","sub":""}];
let swiper, players={}, subs={}, timer=null, playersReady=0;
let userInteracted = false;
let isTransitioning = false;
let apiReady = false;
let initAttempts = 0;

function log(msg){
  console.log('[Player] ' + msg);
}

function showLoading(msg){
  const el = document.getElementById('loading');
  if(el){
    el.textContent = msg || '로딩 중...';
    el.classList.add('show');
  }
}

function hideLoading(){
  const el = document.getElementById('loading');
  if(el) el.classList.remove('show');
}

function getThumbUrl(videoId){
  return 'https://img.youtube.com/vi/'+videoId+'/hqdefault.jpg';
}

function init(){
  log('init() called');
  const w=document.getElementById('wrap');
  if(!w){
    log('ERROR: wrap element not found');
    return;
  }
  
  list.forEach((v,i)=>{
    const d=document.createElement('div'); 
    d.className='swiper-slide '+(v.mode==='fit'?'fit':'full');
    subs[i]=parseSrt(v.sub);
    
    const thumb='<div class="thumb" id="thumb-'+i+'" style="background-image:url(\''+getThumbUrl(v.id)+'\')"></div>';
    const L='<div class="smart-layer" data-idx="'+i+'"></div>';
    const B='<div class="play-btn" id="btn-'+i+'" data-idx="'+i+'"></div>';
    const S='<div class="sub-box" id="sub-'+i+'"></div>';
    const player='<div class="player-wrap"><div id="p-'+i+'"></div></div>';
    
    if(v.mode==='fit') {
      d.innerHTML=(v.top?'<div class="top">'+v.top+'</div>':'')+'<div class="vid-wrap">'+thumb+player+L+B+S+'</div>';
    } else {
      d.innerHTML=thumb+player+L+B+S+'<div class="badge">'+v.title+'</div>';
    }
    w.appendChild(d);
  });
  
  // 이벤트 위임으로 클릭 처리
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.play-btn');
    const layer = e.target.closest('.smart-layer');
    
    if(btn){
      const idx = parseInt(btn.getAttribute('data-idx'));
      log('Play button clicked: ' + idx);
      handlePlayClick(idx);
    } else if(layer){
      const idx = parseInt(layer.getAttribute('data-idx'));
      log('Layer clicked: ' + idx);
      handleLayerClick(idx);
    }
  });
  
  swiper=new Swiper('.swiper',{
    direction:'vertical',
    effect:'slide',
    speed:400,
    loop: false,
    on:{ 
      slideChange:function(){ 
        log('Slide changed to: ' + swiper.activeIndex);
        if(!isTransitioning) {
          handleSlideChange();
        }
      } 
    }
  });
  
  window.addEventListener('resize',function(){
    document.querySelectorAll('.sub-box.show').forEach(function(el){
      font(el,el.innerText.length);
    });
  });
  
  log('init() complete, loading YouTube API...');
  loadYouTubeAPI();
}

function loadYouTubeAPI(){
  showLoading('YouTube API 로딩 중...');
  
  // 이미 로드되어 있는지 확인
  if(window.YT && window.YT.Player){
    log('YouTube API already loaded');
    apiReady = true;
    hideLoading();
    createPlayers();
    return;
  }
  
  // API 스크립트 로드
  var tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  tag.onerror = function(){
    log('ERROR: Failed to load YouTube API');
    showLoading('YouTube API 로드 실패. 새로고침 해주세요.');
  };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
  // 타임아웃 체크
  setTimeout(function(){
    if(!apiReady){
      log('YouTube API load timeout, retrying...');
      if(initAttempts < 3){
        initAttempts++;
        loadYouTubeAPI();
      } else {
        showLoading('YouTube API 로드 실패');
      }
    }
  }, 10000);
}

// YouTube API 콜백 (전역)
window.onYouTubeIframeAPIReady = function(){
  log('onYouTubeIframeAPIReady called');
  apiReady = true;
  hideLoading();
  createPlayers();
};

function createPlayers(){
  log('createPlayers() called');
  
  if(!window.YT || !window.YT.Player){
    log('ERROR: YT.Player not available');
    return;
  }
  
  list.forEach(function(v,i){
    var container = document.getElementById('p-'+i);
    if(!container){
      log('ERROR: Container p-'+i+' not found');
      return;
    }
    
    log('Creating player ' + i + ' for video ' + v.id);
    
    try {
      players[i] = new YT.Player('p-'+i, {
        videoId: v.id,
        host: 'https://www.youtube.com',
        playerVars: {
          'autoplay': 0,
          'controls': 0,
          'rel': 0,
          'showinfo': 0,
          'modestbranding': 1,
          'playsinline': 1,
          'fs': 0,
          'iv_load_policy': 3,
          'start': v.start || 0,
          'enablejsapi': 1,
          'origin': window.location.origin
        },
        events: {
          'onReady': function(e){ onPlayerReady(e,i); },
          'onStateChange': function(e){ onStateChange(e,i); },
          'onError': function(e){ onPlayerError(e,i); }
        }
      });
    } catch(err) {
      log('ERROR creating player ' + i + ': ' + err.message);
    }
  });
}

function onPlayerReady(e,i){
  playersReady++;
  log('Player ' + i + ' ready (' + playersReady + '/' + list.length + ')');
  
  if(playersReady === list.length){
    log('All players ready!');
    hideLoading();
  }
}

function onPlayerError(e, i) {
  log('Player ' + i + ' error: ' + e.data);
  if(userInteracted){
    setTimeout(function(){ next(); }, 1000);
  }
}

function onStateChange(e,i){
  var currentIdx = swiper ? swiper.activeIndex : 0;
  
  if(i !== currentIdx) return;
  
  log('Player ' + i + ' state: ' + e.data);
  
  var btn = document.getElementById('btn-'+i);
  
  if(e.data === YT.PlayerState.PLAYING){
    if(btn) btn.classList.add('hide');
    hideThumb(i);
    startMon(i); 
  } else if(e.data === YT.PlayerState.PAUSED){
    if(btn) btn.classList.remove('hide');
  } else if(e.data === YT.PlayerState.ENDED){
    if(btn) btn.classList.remove('hide');
    if(timer){
      clearInterval(timer);
      timer = null;
    }
    if(userInteracted){
      log('Video ended, going to next');
      setTimeout(function(){ next(); }, 300);
    }
  } else if(e.data === YT.PlayerState.UNSTARTED){
    log('Player ' + i + ' unstarted');
  }
}

function handleSlideChange(){
  stopAll();
  var idx = swiper.activeIndex;
  if(userInteracted){
    setTimeout(function(){ play(idx); }, 300);
  }
}

function handlePlayClick(i){
  log('handlePlayClick: ' + i);
  if(!apiReady){
    log('API not ready yet');
    showLoading('잠시 기다려주세요...');
    return;
  }
  userInteracted = true;
  play(i);
}

function handleLayerClick(i){
  log('handleLayerClick: ' + i);
  if(!apiReady){
    log('API not ready yet');
    return;
  }
  if(!userInteracted){
    userInteracted = true;
    play(i);
    return;
  }
  toggle(i);
}

function hideThumb(i){
  var thumb = document.getElementById('thumb-'+i);
  if(thumb) thumb.classList.add('hide');
}

function showThumb(i){
  var thumb = document.getElementById('thumb-'+i);
  if(thumb) thumb.classList.remove('hide');
}

function toggle(i){
  var p = players[i];
  if(p && typeof p.getPlayerState === 'function'){ 
    var state = p.getPlayerState();
    if(state === YT.PlayerState.PLAYING){
      p.pauseVideo();
    } else {
      p.playVideo();
    }
  }
}

function play(i){
  log('play(' + i + ')');
  var p = players[i];
  
  if(!p){
    log('Player ' + i + ' not found');
    return;
  }
  
  if(typeof p.playVideo !== 'function' || typeof p.seekTo !== 'function'){
    log('Player ' + i + ' not ready, retrying...');
    setTimeout(function(){ play(i); }, 500);
    return;
  }
  
  var startTime = list[i].start || 0;
  log('Seeking to ' + startTime + ' and playing');
  
  try {
    p.seekTo(startTime, true);
    setTimeout(function(){
      try {
        p.playVideo();
        log('playVideo() called for ' + i);
      } catch(e) {
        log('playVideo error: ' + e.message);
      }
    }, 200);
  } catch(e) {
    log('Play error: ' + e.message);
  }
}

function stopAll(){
  log('stopAll()');
  if(timer) {
    clearInterval(timer);
    timer = null;
  }
  
  document.querySelectorAll('.sub-box').forEach(function(el){
    el.classList.remove('show');
    el.innerHTML='';
  });
  
  Object.keys(players).forEach(function(idx){ 
    var p = players[idx];
    if(p && typeof p.pauseVideo === 'function') {
      try {
        p.pauseVideo();
      } catch(e) {}
    }
    showThumb(parseInt(idx));
  });
}

function next(){
  if(isTransitioning) return;
  isTransitioning = true;
  
  var idx = swiper.activeIndex;
  log('next() from ' + idx);
  
  if(idx < list.length - 1){
    swiper.slideNext();
    setTimeout(function(){ isTransitioning = false; }, 500);
  } else {
    log('Looping to first video');
    stopAll();
    swiper.slideTo(0, 400);
    setTimeout(function(){
      isTransitioning = false;
      if(userInteracted){
        play(0);
      }
    }, 600);
  }
}

function startMon(i){
  if(timer) clearInterval(timer);
  
  var p = players[i];
  var end = list[i].end;
  var start = list[i].start || 0;
  var el = document.getElementById('sub-'+i);
  var sDat = subs[i];
  
  log('startMon(' + i + ') end=' + end);
  
  timer = setInterval(function(){
    if(!p || typeof p.getCurrentTime !== 'function') return;
    
    var t;
    try {
      t = p.getCurrentTime();
    } catch(e) {
      return;
    }
    
    if(end > start && t >= (end - 0.3)){
      log('End time reached: ' + t);
      clearInterval(timer);
      timer = null;
      try {
        p.pauseVideo();
      } catch(e) {}
      setTimeout(function(){ next(); }, 200);
      return;
    }
    
    if(sDat && sDat.length && el){
      var row = null;
      for(var j=0; j<sDat.length; j++){
        if(t >= sDat[j].s && t <= sDat[j].e){
          row = sDat[j];
          break;
        }
      }
      if(row){
        var txt = row.t.replace(/\n/g,'<br>');
        if(el.innerHTML !== txt){ 
          el.innerHTML = txt; 
          el.classList.add('show'); 
          font(el, row.t.length); 
        }
      } else { 
        el.classList.remove('show'); 
        el.innerHTML = ''; 
      }
    }
  }, 100);
}

function font(el,len){
  var w = document.querySelector('.swiper');
  w = w ? w.clientWidth : window.innerWidth;
  var r = 0.045; 
  if(len<=5) r=0.08; 
  else if(len<=15) r=0.06; 
  else if(len<=30) r=0.05; 
  else r=0.04;
  el.style.fontSize = (w*r)+'px';
}

function parseSrt(t){
  if(!t || t.indexOf('-->') === -1) return t ? [{s:0,e:9999,t:t}] : [];
  var r=[];
  var regex = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\n|\n$|$)/g;
  var m;
  var text = t + '\n\n';
  while((m = regex.exec(text)) !== null){
    r.push({s:h2s(m[2]), e:h2s(m[3]), t:m[4].trim()});
  }
  return r;
}

function h2s(s){ 
  var p = s.split(':');
  var c = p[2].split(','); 
  return parseInt(p[0])*3600 + parseInt(p[1])*60 + parseInt(c[0]) + parseInt(c[1])/1000;
}

// 페이지 로드 시 초기화
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>