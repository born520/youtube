<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>유튜브 플레이어</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  
  <style>
    body, html { margin: 0; padding: 0; width: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
    body, html, .swiper, .swiper-slide { height: 100vh; height: 100dvh; }

    /* [중요] 플레이어 최대 너비 제한 (데스크탑 대응) */
    .swiper { width: 100%; max-width: 480px; margin: 0 auto; background: #000; position: relative; }
    .swiper-slide { background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; position: relative; }

    iframe { width: 100%; height: 100%; border: 0; pointer-events: none; }
    
    .interaction-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 50; cursor: pointer; background: rgba(0,0,0,0);
    }

    /* [자막 오버레이 스타일] */
    .subtitle-overlay {
      position: absolute; 
      left: 50%; transform: translateX(-50%);
      bottom: 8%; 
      
      width: auto;      
      max-width: 90%;   
      
      text-align: center;
      color: #fff; 
      z-index: 60; 
      pointer-events: none; 
      
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 16px;
      border-radius: 8px;
      
      font-weight: 600; 
      line-height: 1.4; 
      transition: all 0.1s;
      
      opacity: 0; 
    }
    .subtitle-overlay.active { opacity: 1; }

    /* [MODE: FULL] */
    .slide-full .video-container iframe {
      position: absolute; top: 0; left: 50%;
      width: 177.78vh; height: 100dvh;
      transform: translateX(-50%); object-fit: cover;
    }
    @media (max-aspect-ratio: 9/16) {
      .slide-full .video-container iframe { width: 320%; height: 100%; left: -110%; transform: none; }
    }

    /* [MODE: FIT] */
    .slide-fit {
      display: flex; flex-direction: column; background: #000;
    }
    .slide-fit .top-msg {
      width: 100%; padding: 15px; box-sizing: border-box;
      color: #fff; text-align: center; z-index: 10;
      font-weight: bold; font-size: 18px; min-height: 50px;
      flex-shrink: 0;
    }
    .slide-fit .video-wrapper {
      position: relative; width: 100%; flex: 1;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .slide-fit .video-wrapper iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; 
    }
    .slide-fit .subtitle-overlay { bottom: 5%; }

    .title-badge {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px;
      border-radius: 15px; font-size: 14px; z-index: 20;
      opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    .swiper-slide-active .title-badge { opacity: 1; }
  </style>
</head>
<body>

<div class="swiper">
  <div class="swiper-wrapper" id="slide-wrapper"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const videoList = [{"videoId":"rvPVVyl7l98","title":"","viewMode":"fit","start":14.5,"end":30,"topText":"테스트 페이지","subtitleData":"1\n00:00:00,480 --> 00:00:02,960\n네. 존경하는 양산 시민 여러분.\n\n2\n00:00:02,960 --> 00:00:05,279\n곽종포 의장님을 비롯한 선배 동료\n\n3\n00:00:05,279 --> 00:00:07,759\n의원 여러분. 그리고 소통과 공정\n\n4\n00:00:07,759 --> 00:00:10,280\n다시 뛰는 양산을 위해 시민과 함께\n\n5\n00:00:10,280 --> 00:00:12,559\n있으시는 나동현 시장님을 비롯한\n\n6\n00:00:12,559 --> 00:00:15,519\n집행부 공무원 여러분.\n\n7\n00:00:15,519 --> 00:00:17,840\n반갑습니다. 양산시회 송은영\n\n8\n00:00:17,840 --> 00:00:20,439\n의원입니다. 오늘 본 의원은 5분\n\n9\n00:00:20,439 --> 00:00:23,160\n자유 발언을 통해 양산시 달빛 어린이\n\n10\n00:00:23,160 --> 00:00:25,320\n병원 지정을 촉구하고자이 자리에\n\n11\n00:00:25,320 --> 00:00:26,920\n섰습니다.\n\n12\n00:00:26,920 --> 00:00:29,160\n양산시의 인구는 2024년 10월\n\n13\n00:00:29,160 --> 00:00:32,200\n기준으로 약 36만6,명입니다.\n\n14\n00:00:32,200 --> 00:00:35,960\n대한민국 전체 평균 연령은 45.3세\n\n15\n00:00:35,960 --> 00:00:38,360\n경상남도 평균 연령은 46.5세인\n\n16\n00:00:38,360 --> 00:00:41,800\n반면 양산시 평균 연령은 44.1세로\n\n17\n00:00:41,800 --> 00:00:44,719\n세로 경남에서는 가장 젊은 도시이며\n\n18\n00:00:44,719 --> 00:00:46,640\n전국에서도 가장 젊은 도시 중\n\n19\n00:00:46,640 --> 00:00:49,399\n하나입니다. 또한 2024년 10월\n\n20\n00:00:49,399 --> 00:00:52,920\n기준 양산시 0세에서 9세 어린이는\n\n21\n00:00:52,920 --> 00:00:55,199\n27만95명으로\n\n22\n00:00:55,199 --> 00:00:57,079\n양산시 인구의 7.5%를 %를\n\n23\n00:00:57,079 --> 00:00:59,760\n차지하고 있으며이는 경남 각 시군의\n\n24\n00:00:59,760 --> 00:01:02,519\n전체 인구 대비 어린이수의 평균\n\n25\n00:01:02,519 --> 00:01:04,119\n4.6%보다\n\n26\n00:01:04,119 --> 00:01:06,680\n월등이 높습니다. 그리고 경상남도\n\n27\n00:01:06,680 --> 00:01:09,119\n내에서는 최고입니다. 아픔은 시간을\n\n28\n00:01:09,119 --> 00:01:11,159\n기다려 주지 않는다. 그래서 모든\n\n29\n00:01:11,159 --> 00:01:13,680\n사건, 사고, 질병에는 골든 타임이\n\n30\n00:01:13,680 --> 00:01:16,040\n있다라는 말이 있습니다. 내 가족이\n\n31\n00:01:16,040 --> 00:01:18,720\n아프면 마음 조리기 마련입니다. 한밤\n\n32\n00:01:18,720 --> 00:01:21,000\n중에 어린아이가 아프기라도 한다면\n\n33\n00:01:21,000 --> 00:01:22,960\n당장이라도 들쳐 없고 응급실로\n\n34\n00:01:22,960 --> 00:01:25,400\n달려가고 싶지만 항상 비용 때문에\n\n35\n00:01:25,400 --> 00:01:28,280\n망설려집니다. 그래서 아침 병원문이\n\n36\n00:01:28,280 --> 00:01:31,759\n열리자마자 오픈 하기 위해 뜻눈으로\n\n37\n00:01:31,759 --> 00:01:34,079\n밤을 세는 것이 부모의 마음이고이\n\n38\n00:01:34,079 --> 00:01:36,200\n마음을 헤아려 주는 것이 달빛 어린이\n\n39\n00:01:36,200 --> 00:01:39,320\n병원입니다. 달빛 어린이 병원은 소화\n\n40\n00:01:39,320 --> 00:01:41,840\n청소년과 의료 공백을 해결하기 위해\n\n41\n00:01:41,840 --> 00:01:45,040\n만 18세 미만 환자를 대상으로 평일\n\n42\n00:01:45,040 --> 00:01:48,320\n오후 11시 휴일 오후 6시까지\n\n43\n00:01:48,320 --> 00:01:50,520\n운영하는 보건 복지부에서 지정하는\n\n44\n00:01:50,520 --> 00:01:52,680\n의료 기간입니다.\n\n45\n00:01:52,680 --> 00:01:55,200\n달빛 어린이 병원은 어 진료에 대한\n\n46\n00:01:55,200 --> 00:01:57,840\n대기 시간을 줄일 수 있고 응급실보다\n\n47\n00:01:57,840 --> 00:01:59,799\n비용 부담이 적으며 응급실의\n\n48\n00:01:59,799 --> 00:02:01,799\n중환자들로 인한 아이들의 두려움을\n\n49\n00:02:01,799 --> 00:02:04,360\n방지함은 물론 전문적인 소화 진료를\n\n50\n00:02:04,360 --> 00:02:07,280\n받을 수 있어 큰 병이 아니라면 달빛\n\n51\n00:02:07,280 --> 00:02:08,959\n어린이 병원에 가는 것이 아이와\n\n52\n00:02:08,959 --> 00:02:11,680\n부모에게는 안심과 안정감을 주게\n\n53\n00:02:11,680 --> 00:02:13,480\n됩니다.\n\n54\n00:02:13,480 --> 00:02:16,319\n11월 기준으로 전국의 98개의 달빛\n\n55\n00:02:16,319 --> 00:02:18,440\n어린이 병원이 운영되고 있으나\n\n56\n00:02:18,440 --> 00:02:21,200\n경남에는 창원, 김해, 통영,\n\n57\n00:02:21,200 --> 00:02:25,000\n거제에서 단만 운영이 되고 있습니다.\n\n58\n00:02:25,000 --> 00:02:27,360\n이와 비교하여 광주 광역 씨는\n\n59\n00:02:27,360 --> 00:02:30,360\n2023년 9월부터 밤 12시까지\n\n60\n00:02:30,360 --> 00:02:33,160\n연중 무유로 운영되는 공공심야 어린이\n\n61\n00:02:33,160 --> 00:02:36,160\n병원을 개하여 운영 중에 있습니다.\n\n62\n00:02:36,160 --> 00:02:39,000\n광주 강역 씨는 팀장의 강력한 의지와\n\n63\n00:02:39,000 --> 00:02:42,560\n노력으로 시외 병원 의료진을 설득하여\n\n64\n00:02:42,560 --> 00:02:45,239\n12, 15억 원의 예산을 확보하고\n\n65\n00:02:45,239 --> 00:02:47,599\n심야 어린이 진료 체계를 구축한 바가\n\n66\n00:02:47,599 --> 00:02:50,879\n있습니다. 그의 반 양산시는 전국에서\n\n67\n00:02:50,879 --> 00:02:53,200\n가장 젊은 도시이자 어린이 인구\n\n68\n00:02:53,200 --> 00:02:56,280\n비율이 높은 지역이지만 밤이나 휴일에\n\n69\n00:02:56,280 --> 00:02:58,560\n갑자기 아픈 어린이가 상급 병원\n\n70\n00:02:58,560 --> 00:03:00,120\n응급실 외에는 갈 곳이 없는\n\n71\n00:03:00,120 --> 00:03:03,640\n실정입니다. 특히 웅상 지역의 경우\n\n72\n00:03:03,640 --> 00:03:05,720\n동부 지역에서 유일하게 어린이 응급을\n\n73\n00:03:05,720 --> 00:03:08,720\n맡던 웅상중앙 병원이 최근 폐협함에\n\n74\n00:03:08,720 --> 00:03:11,400\n따라 주민들은 울산이나 부산으로\n\n75\n00:03:11,400 --> 00:03:14,080\n나가야 하는 불편을 겪고 있으며 경증\n\n76\n00:03:14,080 --> 00:03:16,560\n환자인 어린이들은 응급 환자에 밀려\n\n77\n00:03:16,560 --> 00:03:19,159\n장시간 대기할 수밖에 없습니다.\n\n78\n00:03:19,159 --> 00:03:21,680\n존경하는 의장님과 동료의원 여러분,\n\n79\n00:03:21,680 --> 00:03:23,920\n그리고 양산 시민 여러분, 의료\n\n80\n00:03:23,920 --> 00:03:26,720\n관계자 여러분, 양산시는 의료 중심\n\n81\n00:03:26,720 --> 00:03:29,360\n도시로 선언한 바 있으며 양산 부산대\n\n82\n00:03:29,360 --> 00:03:32,080\n부진에 바이오 의료 산업 클러스터를\n\n83\n00:03:32,080 --> 00:03:34,400\n조성하기 위해 노력하는 등남권\n\n84\n00:03:34,400 --> 00:03:36,519\n바이오메디컬 산업 거점 도시 기반을\n\n85\n00:03:36,519 --> 00:03:39,120\n마련하고 발전시켜 나갈 계획이라고\n\n86\n00:03:39,120 --> 00:03:41,159\n밝혔습니다.\n\n87\n00:03:41,159 --> 00:03:43,959\n그러나 정작 갑자기 아픈 내 아이를\n\n88\n00:03:43,959 --> 00:03:46,480\n데리고 갈 병원이 없어서 발만 동동\n\n89\n00:03:46,480 --> 00:03:49,879\n구르면서 뜻눈으로 밤을 지세운다면\n\n90\n00:03:49,879 --> 00:03:52,040\n광역 의료 거점 도시라고 말을 할 수\n\n91\n00:03:52,040 --> 00:03:53,760\n있을까요?\n\n92\n00:03:53,760 --> 00:03:56,400\n양산시와 시의 그리고 의료 기관\n\n93\n00:03:56,400 --> 00:03:59,159\n모두가 협력하여 정고 출생률이 높은\n\n94\n00:03:59,159 --> 00:04:01,640\n양산에서 부모들이 자녀의 건강에 대해\n\n95\n00:04:01,640 --> 00:04:04,400\n더 이상 걱정하지 않도록 달빛 어린이\n\n96\n00:04:04,400 --> 00:04:06,760\n병원 지정을 위해 힘을 모아 주시기\n\n97\n00:04:06,760 --> 00:04:09,599\n바랍니다. 시장님의 강력한 의지와\n\n98\n00:04:09,599 --> 00:04:12,480\n지원을 통해 달빛 어린이 병원뿐만\n\n99\n00:04:12,480 --> 00:04:15,120\n아니라 나아가 공공심야 어린이\n\n100\n00:04:15,120 --> 00:04:17,199\n병원까지도 운영이 될 수 있도록\n\n101\n00:04:17,199 --> 00:04:20,840\n적극적인 행정적 노력을 요청드립니다.\n\n102\n00:04:20,840 --> 00:04:23,080\n늦은 밤, 휴일에도 아픈 아이들이\n\n103\n00:04:23,080 --> 00:04:25,759\n없도록, 달리 뜨면 더 빛나는 병원,\n\n104\n00:04:25,759 --> 00:04:28,880\n달빛 어린이 병원,이 글기를 되새기며\n\n105\n00:04:28,880 --> 00:04:31,800\n우리 양산 씨가 더욱 안전하고 건강한\n\n106\n00:04:31,800 --> 00:04:34,160\n아이들의 복음 자리가 되길 진심으로\n\n107\n00:04:34,160 --> 00:04:38,280\n바랍니다. 경청해 주셔서 감사합니다."}];
  let swiper;
  let players = {};
  let subData = {}; 
  let subInterval = null; 

  let savedSoundState = localStorage.getItem('isSoundOn');
  let isGlobalSoundOn = (savedSoundState === 'true');

  function initApp() {
    const wrapper = document.getElementById('slide-wrapper');
    
    videoList.forEach((v, idx) => {
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      const interactionLayer = `<div class="interaction-layer" onclick="activateSound(${idx})"></div>`;

      const parsedSubs = parseSRT(v.subtitleData);
      subData[idx] = parsedSubs;

      let html = '';
      const subOverlay = `<div class="subtitle-overlay" id="sub-overlay-${idx}"></div>`;

      if (v.viewMode === 'fit') {
        slide.classList.add('slide-fit');
        html = `
          ${v.topText ? `<div class="top-msg">${v.topText}</div>` : ''}
          <div class="video-wrapper">
            <div id="player-${idx}"></div>
            ${interactionLayer}
            ${subOverlay}
          </div>`;
      } else {
        slide.classList.add('slide-full');
        html = `
          <div class="video-container">
            <div id="player-${idx}"></div>
            ${interactionLayer}
            ${subOverlay}
          </div>
          <div class="title-badge">${v.title}</div>`;
      }
      slide.innerHTML = html;
      wrapper.appendChild(slide);
    });

    swiper = new Swiper('.swiper', {
      direction: 'vertical',
      effect: 'slide',
      speed: 400,
      loop: false, 
      on: {
        slideChange: function () {
          const idx = this.activeIndex;
          playVideo(idx);
          pauseVideo(this.previousIndex);
        }
      }
    });

    loadYoutubeApi();
    
    window.addEventListener('resize', () => {
       document.querySelectorAll('.subtitle-overlay.active').forEach(el => {
           adjustFontSize(el, el.innerText.length);
       });
    });
  }

  function parseSRT(srtText) {
    if (!srtText) return [];
    if (!srtText.includes('-->')) {
       return [{ start: 0, end: 99999, text: srtText }];
    }
    const pattern = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\n|\n$|$)/g;
    const result = [];
    let match;
    while ((match = pattern.exec(srtText + '\n\n')) !== null) {
      result.push({
        start: timeToSeconds(match[2]),
        end: timeToSeconds(match[3]),
        text: match[4].trim()
      });
    }
    return result;
  }

  function timeToSeconds(timeStr) {
    const parts = timeStr.split(':');
    const seconds = parts[2].split(',');
    return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(seconds[0]) + parseInt(seconds[1]) / 1000;
  }

  function startSubtitleSync(idx) {
    if (subInterval) clearInterval(subInterval);
    const subs = subData[idx];
    const el = document.getElementById('sub-overlay-' + idx);
    const player = players[idx];
    if (!subs || subs.length === 0 || !player || !el) return;

    subInterval = setInterval(() => {
      if (typeof player.getCurrentTime !== 'function') return;
      const curTime = player.getCurrentTime();
      const currentSub = subs.find(s => curTime >= s.start && curTime <= s.end);
      
      if (currentSub) {
        const newText = currentSub.text.replace(/\n/g, '<br>');
        if (el.innerHTML !== newText) {
           el.innerHTML = newText;
           el.classList.add('active');
           adjustFontSize(el, currentSub.text.length);
        }
      } else {
        el.classList.remove('active');
        el.innerHTML = '';
      }
    }, 100); 
  }

  // [핵심 수정] 자막 크기 비율 조정 (데스크탑 대응)
  function adjustFontSize(el, len) {
    const container = document.querySelector('.swiper');
    const containerWidth = container ? container.clientWidth : window.innerWidth;

    let ratio = 0.045; // 기본

    if (len <= 5) {
      ratio = 0.08; 
    } else if (len <= 15) {
      ratio = 0.06; 
    } else if (len <= 30) {
      ratio = 0.05; 
    } else {
      ratio = 0.04; 
    }

    const fontSizePx = containerWidth * ratio;
    el.style.fontSize = fontSizePx + 'px';
  }

  function loadYoutubeApi() {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  }

  window.onYouTubeIframeAPIReady = function() {
    videoList.forEach((v, idx) => {
      players[idx] = new YT.Player('player-' + idx, {
        videoId: v.videoId,
        host: 'https://www.youtube.com',
        playerVars: {
          'autoplay': 1, 'mute': 1, 'controls': 0, 'rel': 0, 
          'showinfo': 0, 'modestbranding': 1, 'playsinline': 1, 
          'fs': 0, 'disablekb': 1, 'iv_load_policy': 3,
          'cc_load_policy': 0, 
          'start': v.start, 'end': v.end > 0 ? v.end : undefined,
          'origin': window.location.origin
        },
        events: {
          'onReady': (event) => {
            if (idx === 0) {
              if (isGlobalSoundOn) event.target.unMute();
              else event.target.mute();
              event.target.playVideo();
              startSubtitleSync(0);
              setTimeout(() => {
                const state = event.target.getPlayerState();
                if (state !== YT.PlayerState.PLAYING) event.target.playVideo();
              }, 500);
            }
          },
          'onStateChange': (event) => onPlayerStateChange(event, idx)
        }
      });
    });
  };

  function onPlayerStateChange(event, idx) {
    if (event.data === YT.PlayerState.PLAYING) startSubtitleSync(idx); 
    else if (subInterval) clearInterval(subInterval); 

    if (event.data === YT.PlayerState.ENDED) {
      if(idx < videoList.length - 1) swiper.slideNext();
      else {
        swiper.slideTo(0);
        setTimeout(() => playVideo(0), 300);
      }
    }
  }

  function activateSound(idx) {
    isGlobalSoundOn = true;
    localStorage.setItem('isSoundOn', 'true'); 
    if (players[idx]) {
      players[idx].unMute();
      if (players[idx].getPlayerState() !== YT.PlayerState.PLAYING) players[idx].playVideo();
    }
  }

  function playVideo(idx) {
    if (players[idx] && typeof players[idx].playVideo === 'function') {
      const v = videoList[idx];
      if (isGlobalSoundOn) players[idx].unMute();
      else players[idx].mute();
      players[idx].seekTo(v.start || 0);
      players[idx].playVideo();
      startSubtitleSync(idx); 
    }
  }

  function pauseVideo(idx) {
    if (players[idx]) typeof players[idx].pauseVideo === 'function' && players[idx].pauseVideo();
    if (subInterval) clearInterval(subInterval); 
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
  else initApp();
</script>
</body>
</html>