<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Player</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
  body,html{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;font-family:sans-serif;}
  .swiper{width:100%;height:100%;max-width:480px;margin:0 auto;background:#000;position:relative;}
  .swiper-slide{display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;position:relative;}
  iframe{width:100%;height:100%;border:0;pointer-events:auto;}
  .smart-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;background:transparent;cursor:pointer;
    clip-path: polygon(0% 0%, 100% 0%, 100% 80%, 65% 80%, 65% 100%, 0% 100%);}
  .play-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70px;height:70px;z-index:55;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;justify-content:center;align-items:center;pointer-events:none;transition:opacity 0.2s;}
  .play-btn::after{content:'';width:0;height:0;border-left:25px solid #fff;border-top:15px solid transparent;border-bottom:15px solid transparent;margin-left:5px;}
  .play-btn.hide{opacity:0;}
  .sub-box{position:absolute;left:50%;transform:translateX(-50%);bottom:10%;width:auto;max-width:90%;text-align:center;color:#fff;z-index:60;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.8);background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:8px;font-weight:600;line-height:1.4;opacity:0;transition:all 0.1s;}
  .sub-box.show{opacity:1;}
  .full iframe{position:absolute;top:0;left:50%;width:177.78vh;height:100%;transform:translateX(-50%);object-fit:cover;}
  @media(max-aspect-ratio:9/16){.full iframe{width:320%;height:100%;left:-110%;transform:none;}}
  .fit{display:flex;flex-direction:column;}
  .fit .top{width:100%;padding:15px;color:#fff;text-align:center;z-index:10;font-weight:bold;min-height:50px;}
  .fit .vid-wrap{position:relative;width:100%;flex:1;display:flex;align-items:center;justify-content:center;}
  .fit iframe{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;}
  .badge{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:5px 15px;border-radius:15px;font-size:14px;z-index:20;pointer-events:none;}
</style>
</head>
<body>
<div class="swiper"><div class="swiper-wrapper" id="wrap"></div></div>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
const list=[{"id":"BTn8QLqevj0","title":"","mode":"full","start":200,"end":210,"top":"","sub":""}];
let swiper, players={}, subs={}, timer=null, apiReady=false, slidersReady=false;

function init(){
  const w=document.getElementById('wrap');
  list.forEach((v,i)=>{
    const d=document.createElement('div'); d.className='swiper-slide '+(v.mode==='fit'?'fit':'full');
    subs[i]=parseSrt(v.sub);
    const L=`<div class="smart-layer" onclick="toggle(${i})"></div>`;
    const B=`<div class="play-btn" id="btn-${i}"></div>`;
    const S=`<div class="sub-box" id="sub-${i}"></div>`;
    const core = `<div id="p-${i}"></div>${L}${B}${S}`;
    
    if(v.mode==='fit') d.innerHTML=`${v.top?`<div class="top">${v.top}</div>`:''}<div class="vid-wrap">${core}</div>`;
    else d.innerHTML=`<div class="video-container">${core}</div><div class="badge">${v.title}</div>`;
    w.appendChild(d);
  });
  
  swiper=new Swiper('.swiper',{
    direction:'vertical',effect:'slide',speed:400,
    on:{ slideChange:()=>{ stopAll(); play(swiper.activeIndex); } }
  });
  
  slidersReady=true;
  tryStart();
  
  window.addEventListener('resize',()=>{document.querySelectorAll('.sub-box.show').forEach(el=>font(el,el.innerText.length));});
}

function onYouTubeIframeAPIReady(){
  list.forEach((v,i)=>{
    players[i]=new YT.Player('p-'+i,{
      videoId:v.id, host:'https://www.youtube.com',
      playerVars:{'autoplay':0,'controls':0,'rel':0,'showinfo':0,'modestbranding':1,'playsinline':1,'fs':0,'iv_load_policy':3,'start':v.start,'origin':window.location.origin},
      events:{'onStateChange':(e)=>state(e,i)}
    });
  });
  apiReady=true;
  tryStart();
}

function tryStart(){
  if(apiReady && slidersReady){
    setTimeout(()=>play(0), 500);
  }
}

function state(e,i){
  const btn=document.getElementById('btn-'+i);
  if(e.data===YT.PlayerState.PLAYING){
    if(btn) btn.classList.add('hide');
    startMon(i); 
  } else {
    if(btn) btn.classList.remove('hide');
    if(e.data===YT.PlayerState.ENDED) next();
  }
}

function toggle(i){
  const p=players[i];
  if(p&&p.getPlayerState){ (p.getPlayerState()===YT.PlayerState.PLAYING)?p.pauseVideo():p.playVideo(); }
}

function play(i){
  const p=players[i];
  if(p&&p.playVideo){ 
    const startTime = list[i].start || 0;
    p.seekTo(startTime, true);
    p.playVideo(); 
  }
}

function stopAll(){
  if(timer) clearInterval(timer); 
  Object.values(players).forEach(p=>{ if(p&&p.pauseVideo) p.pauseVideo(); });
}

function next(){
  const idx=swiper.activeIndex;
  (idx<list.length-1) ? swiper.slideNext() : swiper.slideTo(0);
}

function startMon(i){
  if(timer) clearInterval(timer);
  const p=players[i], end=list[i].end, el=document.getElementById('sub-'+i), sDat=subs[i];
  
  timer=setInterval(()=>{
    if(!p||!p.getCurrentTime) return;
    const t=p.getCurrentTime();
    
    // 종료 시간 체크
    if(end > 0 && t >= (end - 0.3)){
      p.pauseVideo();
      clearInterval(timer);
      setTimeout(()=>next(), 300);
      return;
    }
    
    if(sDat&&sDat.length&&el){
      const row=sDat.find(x=>t>=x.s && t<=x.e);
      if(row){
        const txt=row.t.replace(/\n/g,'<br>');
        if(el.innerHTML!==txt){ el.innerHTML=txt; el.classList.add('show'); font(el,row.t.length); }
      } else { el.classList.remove('show'); el.innerHTML=''; }
    }
  },100);
}

function font(el,len){
  const w=document.querySelector('.swiper')?.clientWidth||window.innerWidth;
  let r=0.045; if(len<=5)r=0.08; else if(len<=15)r=0.06; else if(len<=30)r=0.05; else r=0.04;
  el.style.fontSize=(w*r)+'px';
}

function parseSrt(t){
  if(!t||!t.includes('-->')) return t?[{s:0,e:9999,t:t}]:[];
  const r=[]; let m; const p=/(\d+)\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\n|\n$|$)/g;
  while((m=p.exec(t+'\n\n'))!==null) r.push({s:h2s(m[2]),e:h2s(m[3]),t:m[4].trim()});
  return r;
}
function h2s(s){ const p=s.split(':'), c=p[2].split(','); return parseInt(p[0])*3600+parseInt(p[1])*60+parseInt(c[0])+parseInt(c[1])/1000; }

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',init); else init();
</script></body></html>